# AI 面向的项目基础实现总结（Fish Pond）

## 目标（当前版本）
- 按钮 **+1 条鱼**：往鱼塘添加会游动的鱼。
- 点击画布投喂 **饲料**。
- 鱼在 **视野半径** 内发现饲料会朝其移动并在接触时吃掉。
- 每吃 1 个饲料，**sizeScale *= 1.01**（体型 +1%）。

## 技术栈与约束
- **React 18 + Vite + TypeScript**
- UI 使用 Tailwind（通过 CDN 注入）。
- 渲染使用 **HTMLCanvasElement** 2D 上下文；逐帧 `requestAnimationFrame` 驱动。
- 高 DPI 处理：根据容器尺寸与 `devicePixelRatio` 设置 canvas 内外尺寸并 `setTransform`。

## 核心数据结构
```ts
interface Food { id: number; x: number; y: number; r: number; }
interface Fish {
  id: number; x: number; y: number; vx: number; vy: number;
  speed: number; sizeScale: number; color: string; vision: number;
  targetFoodId: number | null; wanderT: number;
}
```
- **状态存储**：`useRef` 持有 `fishRef: Fish[]`、`foodRef: Food[]`，避免每帧引发 React 重渲染；仅在需要展示计数时使用 `setState`。
- **ID 分配**：`nextIdRef` 自增。

## 关键参数（可调）
- `FISH_SPEED_MIN/MAX`：鱼的基础速度区间。
- `FISH_TURN_SMOOTH`：速度/转向插值（0~1）。
- `FISH_VISION`：视野半径（像素）。
- `EAT_RADIUS`：鱼嘴吃判定半径（按体型缩放后参与碰撞）。
- `FOOD_RADIUS`：饲料半径。

## 主循环（每帧）
1. 计算 `dt`（上限 50ms 防穿透）。
2. 背景绘制（水面渐变 + 轻微水纹）。
3. 绘制所有 `food`（棕色小圆）。
4. 对每条 `fish`：
   - **寻食**：扫描 `foodRef` 找到距离最近且在 `vision` 内的饲料（线性 O(N)）。
   - **速度决策**：有目标则朝目标归一化方向加速；否则使用 `wanderT` 生成左右摆尾噪声实现巡游。
   - **速度平滑**：`vx, vy = lerp(current, desired, FISH_TURN_SMOOTH)`。
   - **积分**：`x += vx * dt; y += vy * dt`。
   - **边界**：与四边界碰撞后反弹（约束至边缘内）。
   - **吃饭**：与任一食物距离 ≤ `EAT_RADIUS * sizeScale + FOOD_RADIUS` 即吃掉，`sizeScale *= 1.01`。
5. 统计并更新 UI 上的食物计数。
6. 绘制鱼（身体椭圆 + 三角头 + 尾鳍 + 眼睛；基于当前速度方向旋转）。

## 输入与事件
- **点击画布**：在点击位置添加 `Food`。
- **按钮**：添加鱼；清空鱼；清空食物。
- **Alt+V**：切换显示鱼的视野圈（调试）。

## 可扩展点（建议）
- 性能：将寻食/碰撞从 O(N×M) 改为 **网格/四叉树** 空间索引。
- 行为：加入 **饥饿/能量**、**避障**、**群游（Boids 三规则）**、**不同鱼种**（视觉/速度/食量不同）。
- 交互：**长按投喂**（连续掉落）、**拖拽投喂**、**移动端触摸** 支持。
- 画面：为鱼添加 **体型渐变动画**、**阴影/泡泡粒子**、**鱼名/等级**。 
- 存档：`localStorage` 保存鱼群（体型、颜色、成长）。

## 代码风格约定
- **逻辑与渲染分离**：先更新状态，再绘制。
- 对所有随机因子与常量提供 **参数化**，便于 AI 调参。
- 新增特性时补充 **验收标准**（见下）。

## 验收标准（最小回归集）
- 添加鱼后：出现在画布内随机位置，立即以随机方向/速度巡游；不穿墙；参数边界安全。
- 点击投喂：在点击点生成 1 枚饲料，显示在 UI 计数中。
- 寻食：当饲料进入任意鱼的 `vision` 时，该鱼朝饲料移动；接触即移除食物。
- 成长：每吃掉 1 枚，`sizeScale` 乘上 `1.01`，实际绘制尺寸随之增大。

## 任务列表示例（按易→难）
- **A1｜移动端交互**：支持触摸点投喂（tap）与长按连续投喂；验收：手机可流畅运行，长按每 120ms 自动添加 1 枚食物，抬手停止。
- **A2｜多鱼种**：添加 `species` 字段与参数表（速度/视野/颜色分布/吃饭半径系数）；添加一个下拉框选择“新鱼物种”；验收：不同物种的行为差异体现在速度与视野。
- **A3｜空间网格**：实现固定网格（cellSize≈视野半径），仅在相邻格子间寻食与碰撞；在鱼>80 / 食物>200 时仍稳定 60FPS。
- **A4｜饥饿与自动投喂**：鱼有 `energy` 持续下降；低于阈值加速寻食；无食物时每 3s 自动在随机位置生成饲料。验收：能量在 UI 可见且与行为联动。
- **A5｜Boids 群游**：加入对同类鱼的对齐/分离/聚合三规则（可开关）；验收：关→单鱼游走；开→出现群体协同行为。
- **A6｜存档**：保存并恢复 `fishRef` 与 `foodRef` 至 `localStorage`；验收：刷新页面后鱼的体型与数量一致。