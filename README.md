# 🐟 小鱼塘 Mini-Game

一个使用 React, TypeScript 和 Firebase 构建的简单小鱼塘模拟游戏。

## ✨ 功能

- **鱼儿模拟**: 鱼在池塘里游动，拥有觅食、闲逛等行为。
- **投喂互动**: 点击池塘任意位置可以投喂饲料，看着鱼儿吃掉它们并长大。
- **高度自定义**:
    - **自定义鱼形**: 通过轮廓编辑器，可以绘制全新的鱼形。
    - **自定义贴图**: 可以为不同鱼形绘制独一无二的纹理贴图。
    - **程序化贴图**: 内置了多种程序化生成的鱼类贴图，如小丑鱼、蓝吊等。
- **数据持久化**: 你的鱼塘状态（鱼、饲料）会被自动保存在本地浏览器中。
- **实时云同步**:
    - 鱼塘可以通过链接分享给朋友。
    - 所有在鱼塘中的操作都会实时同步到云端（Firebase Firestore），并在所有打开该链接的客户端间同步。

## 🔧 技术架构

### 前端
- **框架**: React (Vite)
- **语言**: TypeScript
- **样式**: Tailwind CSS

### 后端与数据同步
- **数据库**: Google Firestore
- **认证**: Firebase Anonymous Authentication
- **实时同步**: Firestore real-time listener (`onSnapshot`)

### 核心同步逻辑 (S6.2C)

为了解决多端（或多标签页）同时操作时可能出现的数据覆盖问题，项目采用了一个基于版本号 (`docRev`) 的乐观锁同步策略。

1.  **云端优先原则**:
    - 应用启动时，总是优先从 Firestore 加载云端数据。
    - 只有当云端不存在任何数据时（例如，一个全新的鱼塘），才会使用本地数据进行初始化，并立即推送到云端。

2.  **版本号 (`docRev`)**:
    - 每个鱼塘在云端和本地都维护一个版本号 `docRev`。
    - **本地操作**: 任何导致数据变更的关键操作（如添加鱼、清空池塘）都会使本地 `docRev` 加一，并立即将新数据和新版本号写入云端。
    - **云端监听**: 客户端会监听云端数据的变化。当接收到新的云端数据时，会比较其 `docRev` 和本地的 `docRev`。
    - **冲突解决**:
        - 如果云端 `docRev` **大于** 本地 `docRev`，说明是来自其他客户端的更新，本地将接受并覆盖为云端数据。
        - 如果云端 `docRev` **小于或等于** 本地 `docRev`，说明是过时的数据（或自己刚刚写入的回声），本地将忽略它。

3.  **立即写云 vs. 节流写云**:
    - **关键操作**: 用户的直接操作（如创建一条鱼、清空鱼塘）被认为是高优先级，会**立即**触发云端写入，确保操作的意图最快被同步。
    - **高频操作**: 一些高频的、非核心状态变更（如鱼吃了饲料长大）会采用**节流**方式上云，以节省写入成本并避免不必要的流量。

### 贴图处理与持久化

- **贴图存储**: 自定义绘制的贴图（dataURL）会被存储在 Firestore 的 `textures` 集合中。
- **ID 与去重**: 贴图的 ID 是其 dataURL 内容的 SHA-256 哈希值，这天然地实现了相同贴图的去重存储。
- **贴图回填 (Hydration)**:
    - 为了节省云端主文档的大小，鱼的数据中只存储 `textureId`，而不存储完整的 dataURL。
    - 当应用启动或从云端同步数据后，会触发一个 `resolveTexturesForFish` 函数。
    - 该函数会检查哪些鱼有 `textureId` 但缺少 `textureDataUrl`，然后从 `textures` 集合中批量获取它们，并填充回运行时的鱼对象中。
- **本地缓存**: 获取到的贴图 dataURL 会被缓存在浏览器的 `localStorage` 中，以避免重复的网络请求，加快后续加载速度。
